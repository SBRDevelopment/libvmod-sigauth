varnishtest "Test sigauth hmac-method"

		
server s1 {
       rxreq
       txresp
} -start

varnish v1 -vcl+backend {
		
		import digest;
        import sigauth from "${vmod_topbuild}/src/.libs/libvmod_sigauth.so";

		sub vcl_recv {
			set req.http.sigstring = digest.base64(sigauth.sigstring(req.request, req.url, "uFehWXvcM7mf==c8ZhOe3Fz+6d+zyQ2ja4A3De1N"));
		}
		
		sub vcl_deliver {
			set resp.http.sigstring = req.http.sigstring;
		}
} -start

client c1 {
	txreq -req "POST" -url "/" \
		-hdr "host: api.sbrfeeds.com" \
		-hdr "date: 2013-01-15T00:00:00" \
		-hdr "content-type: application/json" \
		-hdr "x-sbr-content: testing" \
		-body "{'value':'123456789'}"
    rxresp
	expect resp.http.sigstring == "8+K4vBT40Jv2wVGxuvJc3/9ssPc="
}

client c1 -run
